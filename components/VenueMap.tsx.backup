// components/VenueMap.tsx
import React, { useContext, useEffect, useState } from 'react';
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { TeamContext } from '../context/TeamContext';
import { Venue } from '../types';

// Fix for default marker icons in Leaflet
delete (L.Icon.Default.prototype as any)._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: '/leaflet/images/marker-icon-2x.png',
  iconUrl: '/leaflet/images/marker-icon.png',
  shadowUrl: '/leaflet/images/marker-shadow.png',
});

interface VenueMapProps {
  highlightedCity?: string;
  onVenueClick?: (venue: Venue) => void;
  interactive?: boolean;
}

// Sample venue data - in a real app, this would come from your data source
const sampleVenues: Venue[] = [
  {
    id: '1',
    name: 'Estadio Azteca',
    city: 'Mexico City',
    country: 'Mexico',
    capacity: 87523,
    latitude: 19.3028,
    longitude: -99.1503,
  },
  {
    id: '2',
    name: 'SoFi Stadium',
    city: 'Los Angeles',
    country: 'USA',
    capacity: 70240,
    latitude: 33.9535,
    longitude: -118.3391,
  },
  {
    id: '3',
    name: 'MetLife Stadium',
    city: 'New York',
    country: 'USA',
    capacity: 82500,
    latitude: 40.8135,
    longitude: -74.0745,
  },
  {
    id: '4',
    name: 'AT&T Stadium',
    city: 'Dallas',
    country: 'USA',
    capacity: 80000,
    latitude: 32.7473,
    longitude: -97.0945,
  },
  {
    id: '5',
    name: 'Mercedes-Benz Stadium',
    city: 'Atlanta',
    country: 'USA',
    capacity: 71000,
    latitude: 33.7555,
    longitude: -84.4012,
  },
  {
    id: '6',
    name: 'Levi\'s Stadium',
    city: 'San Francisco',
    country: 'USA',
    capacity: 68500,
    latitude: 37.4030,
    longitude: -121.9700,
  },
  {
    id: '7',
    name: 'BC Place',
    city: 'Vancouver',
    country: 'Canada',
    capacity: 54500,
    latitude: 49.2769,
    longitude: -123.1144,
  },
  {
    id: '8',
    name: 'Commonwealth Stadium',
    city: 'Edmonton',
    country: 'Canada',
    capacity: 56000,
    latitude: 53.5606,
    longitude: -113.4741,
  },
  {
    id: '9',
    name: 'BMO Field',
    city: 'Toronto',
    country: 'Canada',
    capacity: 45000,
    latitude: 43.6336,
    longitude: -79.4189,
  },
  {
    id: '10',
    name: 'Estadio BBVA',
    city: 'Monterrey',
    country: 'Mexico',
    capacity: 53460,
    latitude: 25.6702,
    longitude: -100.2405,
  },
  {
    id: '11',
    name: 'Estadio Akron',
    city: 'Guadalajara',
    country: 'Mexico',
    capacity: 49050,
    latitude: 20.6818,
    longitude: -103.4635,
  },
  {
    id: '12',
    name: 'Estadio Cuauht√©moc',
    city: 'Puebla',
    country: 'Mexico',
    capacity: 51500,
    latitude: 19.0836,
    longitude: -98.1983,
  },
  {
    id: '13',
    name: 'Hard Rock Stadium',
    city: 'Miami',
    country: 'USA',
    capacity: 65326,
    latitude: 25.9580,
    longitude: -80.2389,
  },
  {
    id: '14',
    name: 'Gillette Stadium',
    city: 'Boston',
    country: 'USA',
    capacity: 65878,
    latitude: 42.0909,
    longitude: -71.2643,
  },
  {
    id: '15',
    name: 'Lumen Field',
    city: 'Seattle',
    country: 'USA',
    capacity: 69000,
    latitude: 47.5952,
    longitude: -122.3316,
  },
  {
    id: '16',
    name: 'Allegiant Stadium',
    city: 'Las Vegas',
    country: 'USA',
    capacity: 65000,
    latitude: 36.0908,
    longitude: -115.1835,
  },
];

const VenueMap: React.FC<VenueMapProps> = ({ 
  highlightedCity, 
  onVenueClick, 
  interactive = true 
}) => {
  const { setSelectedTeam } = useContext(TeamContext);
  const [venues, setVenues] = useState<Venue[]>(sampleVenues);
  const [mapCenter, setMapCenter] = useState<[number, number]>([39.8283, -98.5795]); // Center of North America
  const [zoom, setZoom] = useState(4);

  // Custom icon for highlighted venues
  const createHighlightIcon = () => {
    return L.divIcon({
      className: 'highlighted-venue-marker',
      html: `
        <div style="
          width: 24px;
          height: 24px;
          background: linear-gradient(135deg, #10B981, #059669);
          border-radius: 50%;
          border: 3px solid white;
          box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3), 0 0 20px rgba(16, 185, 129, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <div style="
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
          "></div>
        </div>
      `,
      iconSize: [24, 24],
      iconAnchor: [12, 12],
    });
  };

  // Custom icon for regular venues
  const createRegularIcon = () => {
    return L.divIcon({
      className: 'regular-venue-marker',
      html: `
        <div style="
          width: 16px;
          height: 16px;
          background: #3B82F6;
          border-radius: 50%;
          border: 2px solid white;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        "></div>
      `,
      iconSize: [16, 16],
      iconAnchor: [8, 8],
    });
  };

  // Custom icon for currently selected venue (if any)
  const createSelectedIcon = () => {
    return L.divIcon({
      className: 'selected-venue-marker',
      html: `
        <div style="
          width: 20px;
          height: 20px;
          background: #EF4444;
          border-radius: 50%;
          border: 3px solid white;
          box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3), 0 0 15px rgba(239, 68, 68, 0.4);
          display: flex;
          align-items: center;
          justify-content: center;
          animation: pulse 1.5s infinite;
        ">
          <div style="
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
          "></div>
        </div>
      `,
      iconSize: [20, 20],
      iconAnchor: [10, 10],
    });
  };

  // Handle venue click
  const handleVenueClick = (venue: Venue) => {
    if (onVenueClick) {
      onVenueClick(venue);
    }
    
    // You could also set a selected team based on venue
    // For now, we'll just log it
    console.log('Venue clicked:', venue);
    
    // Center map on clicked venue
    setMapCenter([venue.latitude, venue.longitude]);
    setZoom(10);
  };

  // Filter venues by highlighted city
  const highlightedVenues = highlightedCity 
    ? venues.filter(venue => venue.city === highlightedCity)
    : [];

  // Add custom CSS for animations
  useEffect(() => {
    const style = document.createElement('style');
    style.innerHTML = `
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        }
      }
      
      .highlighted-venue-marker {
        filter: drop-shadow(0 4px 6px rgba(16, 185, 129, 0.5));
        z-index: 1000 !important;
      }
      
      .regular-venue-marker {
        transition: all 0.3s ease;
        z-index: 100 !important;
      }
      
      .regular-venue-marker:hover {
        transform: scale(1.2);
        filter: brightness(1.1);
        z-index: 1000 !important;
      }
      
      .selected-venue-marker {
        z-index: 1001 !important;
      }
      
      .leaflet-popup-content {
        margin: 12px !important;
        min-width: 200px;
      }
      
      .venue-popup h3 {
        margin: 0 0 8px 0 !important;
        font-size: 16px !important;
        font-weight: 600 !important;
        color: #111827 !important;
      }
      
      .venue-popup p {
        margin: 4px 0 !important;
        font-size: 14px !important;
        color: #6B7280 !important;
      }
      
      .highlighted-badge {
        display: inline-block !important;
        background: #10B981 !important;
        color: white !important;
        padding: 2px 8px !important;
        border-radius: 12px !important;
        font-size: 12px !important;
        margin-top: 8px !important;
      }
    `;
    document.head.appendChild(style);

    return () => {
      document.head.removeChild(style);
    };
  }, []);

  return (
    <div className="venue-map-container bg-white rounded-lg shadow-lg overflow-hidden">
      {/* Map Header */}
      <div className="p-4 border-b border-gray-200">
        <div className="flex justify-between items-center">
          <h2 className="text-xl font-bold text-gray-800">World Cup 2026 Venues</h2>
          <div className="flex items-center space-x-4">
            <div className="flex items-center">
              <div className="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
              <span className="text-sm text-gray-600">Venue</span>
            </div>
            {highlightedCity && (
              <div className="flex items-center">
                <div className="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                <span className="text-sm text-gray-600">Highlighted: {highlightedCity}</span>
              </div>
            )}
          </div>
        </div>
        
        {highlightedCity && (
          <div className="mt-2 p-3 bg-green-50 rounded-lg border border-green-200">
            <div className="flex items-center">
              <svg className="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
              </svg>
              <p className="text-green-700 font-medium">
                Showing venues in <span className="font-bold">{highlightedCity}</span> - 
                Home to {highlightedVenues.length} stadium{highlightedVenues.length !== 1 ? 's' : ''}
              </p>
            </div>
          </div>
        )}
      </div>

      {/* Map Container */}
      <div className="relative">
        <div className="h-[500px] w-full relative">
          <MapContainer
            center={mapCenter}
            zoom={zoom}
            style={{ height: '100%', width: '100%' }}
            scrollWheelZoom={interactive}
            zoomControl={interactive}
            dragging={interactive}
          >
            <TileLayer
              attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
              url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
            />
            
            {/* Render regular venues */}
            {venues
              .filter(venue => !highlightedCity || venue.city !== highlightedCity)
              .map(venue => (
                <Marker
                  key={`regular-${venue.id}`}
                  position={[venue.latitude, venue.longitude]}
                  icon={createRegularIcon()}
                  eventHandlers={{
                    click: () => handleVenueClick(venue),
                  }}
                >
                  <Popup>
                    <div className="venue-popup">
                      <h3>{venue.name}</h3>
                      <p>üìç {venue.city}, {venue.country}</p>
                      <p>üèüÔ∏è Capacity: {venue.capacity.toLocaleString()}</p>
                      {interactive && (
                        <button 
                          className="mt-2 px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors"
                          onClick={() => handleVenueClick(venue)}
                        >
                          View Details
                        </button>
                      )}
                    </div>
                  </Popup>
                </Marker>
              ))}
            
            {/* Render highlighted venues with green markers */}
            {highlightedVenues.map(venue => (
              <Marker
                key={`highlighted-${venue.id}`}
                position={[venue.latitude, venue.longitude]}
                icon={createHighlightIcon()}
                eventHandlers={{
                  click: () => handleVenueClick(venue),
                }}
              >
                <Popup>
                  <div className="venue-popup">
                    <h3>{venue.name}</h3>
                    <p>üìç {venue.city}, {venue.country}</p>
                    <p>üèüÔ∏è Capacity: {venue.capacity.toLocaleString()}</p>
                    <div className="highlighted-badge">
                      ‚≠ê Currently Highlighted
                    </div>
                    {interactive && (
                      <button 
                        className="mt-2 px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition-colors"
                        onClick={() => handleVenueClick(venue)}
                      >
                        View Venue Details
                      </button>
                    )}
                  </div>
                </Popup>
              </Marker>
            ))}
          </MapContainer>
        </div>

        {/* Legend */}
        <div className="absolute bottom-4 left-4 bg-white p-3 rounded-lg shadow-lg z-[1000] max-w-xs">
          <h4 className="font-semibold text-gray-800 mb-2">Map Legend</h4>
          <div className="space-y-2">
            <div className="flex items-center">
              <div className="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
              <span className="text-sm text-gray-600">World Cup Venue</span>
            </div>
            {highlightedCity && (
              <div className="flex items-center">
                <div className="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                <span className="text-sm text-gray-600">Team Venue: {highlightedCity}</span>
              </div>
            )}
            <div className="text-xs text-gray-500 mt-2">
              {interactive ? 'Click markers for details' : 'Zoom and pan to explore'}
            </div>
          </div>
        </div>

        {/* Stats */}
        <div className="absolute top-4 right-4 bg-white/90 backdrop-blur-sm p-3 rounded-lg shadow-lg z-[1000]">
          <div className="text-sm text-gray-700">
            <div className="font-medium">Venue Statistics</div>
            <div className="mt-1 space-y-1">
              <div>Total Venues: <span className="font-semibold">{venues.length}</span></div>
              {highlightedCity && (
                <div>
                  In {highlightedCity}: <span className="font-semibold text-green-600">{highlightedVenues.length}</span>
                </div>
              )}
              <div>Avg Capacity: <span className="font-semibold">
                {Math.round(venues.reduce((acc, v) => acc + v.capacity, 0) / venues.length).toLocaleString()}
              </span></div>
            </div>
          </div>
        </div>
      </div>

      {/* Venue List (for smaller screens or as reference) */}
      <div className="p-4 border-t border-gray-200">
        <details className="group">
          <summary className="flex justify-between items-center cursor-pointer text-gray-700 font-medium">
            <span>View All Venues List</span>
            <svg className="w-5 h-5 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
            </svg>
          </summary>
          <div className="mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {venues.map(venue => (
              <div 
                key={`list-${venue.id}`}
                className={`p-3 rounded border ${
                  highlightedCity && venue.city === highlightedCity
                    ? 'bg-green-50 border-green-200'
                    : 'bg-gray-50 border-gray-200'
                }`}
              >
                <div className="flex justify-between items-start">
                  <div>
                    <h4 className="font-medium text-gray-800">{venue.name}</h4>
                    <p className="text-sm text-gray-600">{venue.city}, {venue.country}</p>
                  </div>
                  <div className="text-right">
                    <div className="font-bold text-gray-900">{venue.capacity.toLocaleString()}</div>
                    <div className="text-xs text-gray-500">capacity</div>
                  </div>
                </div>
                {highlightedCity && venue.city === highlightedCity && (
                  <div className="mt-2 flex items-center text-green-600 text-sm">
                    <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                    </svg>
                    Team Venue
                  </div>
                )}
              </div>
            ))}
          </div>
        </details>
      </div>
    </div>
  );
};

export default VenueMap;
